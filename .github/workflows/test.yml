name: Test DAFoam MCP Server

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  DOCKER_WORKING_DIR: '/home/dafoamuser/dafoam/dafoam_mcp_server'
  DOCKER_MOUNT_DIR: '/home/dafoamuser/mount/dafoam_mcp_server'
  DOCKER_ENV_FILE: '/home/dafoamuser/dafoam/loadDAFoam.sh'

jobs:
  test:
    runs-on: ubuntu-latest
    name: Integration Tests
    steps:
    - uses: actions/checkout@v4

    - name: Pull base Docker image
      run: docker pull dafoam/opt-packages:mcp

    - name: Build Docker image
      run: docker build -t dafoam_mcp_server .

    - name: Create container and run tests
      run: |
        docker run -i -d -u dafoamuser --name test_container -v $GITHUB_WORKSPACE:${{env.DOCKER_MOUNT_DIR}} dafoam_mcp_server /bin/bash
        docker exec -i test_container /bin/bash -c "rm -rf ${{env.DOCKER_WORKING_DIR}} && cp -r ${{env.DOCKER_MOUNT_DIR}} ${{env.DOCKER_WORKING_DIR}}"
        docker exec -i test_container /bin/bash -c ". ${{env.DOCKER_ENV_FILE}} && cd ${{env.DOCKER_WORKING_DIR}} && python tests/integration_tests.py"
